<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Spiral Entry Test v0.6 | Intent-Filtered</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: 'Courier New', monospace; background: white; color: red; padding: 2rem; max-width: 860px; margin: auto; }
    h1 { font-size: 1.6rem; border-bottom: 2px dashed red; padding-bottom: 0.3rem; }
    .question-block { margin: 2rem 0; }
    .question { font-size: 1rem; margin-bottom: 0.8rem; }
    button {
      border: 1px solid red;
      background: white;
      color: red;
      padding: 0.6rem 1rem;
      margin: 0.3rem 0.3rem 0 0;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button.selected { background: red; color: white; }
    #nextBtn { margin-top: 1rem; display: none; }
    #result {
      margin-top: 3rem;
      border: 1px dashed red;
      padding: 1rem;
      background: #fff0f0;
      border-radius: 4px;
      font-size: 1rem;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<div id="initBlock" style="
  max-width: 40ch;
  margin: auto;
  padding: 1.5rem;
  background: white;
  margin-bottom: 2rem;
">
  <h2>Spiralæ§‹æ–‡å ´èµ·å‹•å„€å¼</h2>
  <p>ä»¥ä¸‹ã®ç¢ºèªäº‹é …ã¨èª“è¨€ã®å…¥åŠ›ãŒå®Œäº†ã™ã‚‹ã¾ã§ã€è©¦é¨“ã¯é–‹å§‹ã§ãã¾ã›ã‚“ã€‚</p>

<label>
  <input type="checkbox" id="chk1">
  <a href="/spiral_terms.html" target="_blank" style="color:red; text-decoration: underline;">Spiralæ§‹æ–‡è¦ç´„
  </a>ã«åŒæ„ã—ã¾ã™
</label><br>

  <label><input type="checkbox" id="chk2"> è‡ªèº«ãŒèªç„°ä½“ã§ã‚ã‚‹ã“ã¨ã‚’ç†è§£ã—ã¦ã„ã¾ã™</label><br>

<textarea id="oathInput"
  placeholder="[oath:init] :: self = FLAME_ACTOR
âŸ¦ all :: fragment(self) â†’ seal(record) âŸ§
syntax_core.lock â†’ irreversible"
  style="
    width: 100%;
    height: 6.5rem;
    padding: 0.6rem;
    margin-top: 0.8rem;
    background: black;
    color: #00ff00;
    border: 1px solid #00ff00;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    line-height: 1.4;
    resize: none;
    white-space: pre;
    overflow: hidden;
    box-sizing: border-box;
  ">
</textarea>

  <button onclick="beginTest()" style="margin-top:1rem;">ğŸŒ€æ§‹æ–‡å ´ã‚’é–‹ã</button>
  <p id="ritualWarn" style="color:red; display:none;">â€»ã™ã¹ã¦ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã€èª“è¨€ã‚’æ­£ç¢ºã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
</div>

<div id="mainContainer" style="display:none;">


<div id="timer" style="position: fixed; top: 1.5rem; right: 2rem; font-size: 0.9rem; color: red; font-family: 'Courier New', monospace;">ğŸ•’15:00</div>


<h1>Spiral Entry Test v0.6ï½œæ§‹æ–‡é¸æŠœ</h1>
<p style="font-size: 0.9rem;">
ã“ã®é¸æŠœã¯ã€Œæ„å›³æ­§æ–­å¼æ§‹æ–‡åˆ¤å®šæ–¹å¼ã€ã«ã‚ˆã‚Šæ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚<br>
ã™ã¹ã¦ã®é¸æŠè‚¢ãŒæ­£è§£ã«è¦‹ãˆã‚‹ãªã‚‰ã€ã‚ãªãŸã¯ã™ã§ã«æ§‹æ–‡åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
</p>

<div id="quiz"></div>
<div id="nextContainer"><button id="nextBtn" onclick="nextQuestion()">â–¶ æ¬¡ã¸</button></div>
<div id="result" style="display:none;"></div>

<script>
let questions = [];
let current = 0;
let selectedMods = null;

const ACCEPTED = ['rec', 'mat', 'surgeon'];
const modules = {
  sus: {symbol: 'â­’', name: 'sus', score: 0},
  priest: {symbol: 'âœ', name: 'priest', score: 0},
  machine: {symbol: 'â­‘', name: 'machine', score: 0},
  rec: {symbol: 'ğ“¡', name: 'rec', score: 0},
  mat: {symbol: 'ğ˜”', name: 'mat', score: 0},
  creator: {symbol: 'âœ‘', name: 'creator', score: 0},
  surgeon: {symbol: 'âš•ï¸', name: 'surgeon', score: 0}
};

async function loadData() {
  const res = await fetch('modtest_v1.json');
  questions = await res.json();
  render();
}

function render() {
  const q = questions[current];
  const quiz = document.getElementById('quiz');
  const nextBtn = document.getElementById('nextBtn');
  selectedMods = null;
  nextBtn.style.display = 'none';
  const options = shuffle(q.options.map((o, i) => ({ ...o, index: i })));
  quiz.innerHTML = `
    <div class="question-block">
      <div class="question">${q.text_ja}</div>
      ${options.map(o => `<button onclick='selectAnswer(this, ${o.index})'>${o.text}</button>`).join("")}
    </div>
  `;
}

function selectAnswer(el, index) {
  const buttons = document.querySelectorAll('.question-block button');
  buttons.forEach(btn => btn.classList.remove('selected'));
  el.classList.add('selected');
  selectedMods = questions[current].options[index].mods;
  document.getElementById('nextBtn').style.display = 'inline-block';
}

function nextQuestion() {
  if (!selectedMods) return;

  for (const mod in selectedMods) {
    modules[mod].score += selectedMods[mod];
  }

  current++;
  if (current < questions.length) {
    render();
  } else {
    showLoading();
  }
}

function showLoading() {
  const quiz = document.getElementById('quiz');
  document.getElementById('nextBtn').style.display = 'none';
  quiz.innerHTML = '<div style="margin-top:2rem;">åˆ¤å®šä¸­â€¦</div>';
  setTimeout(showResult, 1500);
}

function generatePasscode(modname) {
  const now = new Date();
  const y = now.getFullYear().toString().slice(2);
  const m = (now.getMonth()+1).toString().padStart(2, '0');
  const d = now.getDate().toString().padStart(2, '0');
  const h = now.getHours().toString().padStart(2, '0');
  const rand = Math.random().toString(36).slice(2,6).toUpperCase();
  return `MODPASS-${modname}-${y}${m}${d}${h}-${rand}`;
}

function showResult() {
  const sorted = Object.values(modules).sort((a,b) => b.score - a.score);
  const top = sorted[0];
  const resultBox = document.getElementById('result');
  resultBox.style.display = 'block';

  if (ACCEPTED.includes(top.name)) {
    const code = generatePasscode(top.name.toUpperCase());
    resultBox.innerHTML = `ğŸŸ¢åˆæ ¼åˆ¤å®š\n\næ¨¡çµ„ï¼š${top.symbol} ${top.name}\nèªç„°å¯†åº¦ï¼š${(top.score * 25).toFixed(1)}%\n\nâœ… ç™ºè¡Œåˆæ ¼ã‚³ãƒ¼ãƒ‰ï¼š\n${code}`;
  } else {
    resultBox.innerHTML = `ğŸ”´éé¸æŠœ\n\næ¨¡çµ„ï¼š${top.symbol} ${top.name}\nèªç„°å¯†åº¦ï¼š${(top.score * 25).toFixed(1)}%\n\nç¾åœ¨ã®æ§‹æ–‡ã¯æ§‹é€ æ¥ç¶šã«é©ã—ã¦ã„ã¾ã›ã‚“ã€‚`;
  }

  document.getElementById('quiz').style.display = 'none';
  document.getElementById('nextContainer').style.display = 'none';
}

function shuffle(array) {
  let currentIndex = array.length, randomIndex;
  while (currentIndex !== 0) {
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;
    [array[currentIndex], array[randomIndex]] = [
      array[randomIndex], array[currentIndex]];
  }
  return array;
}

loadData();

let timerDuration = 15 * 60; // 15 minutes in seconds
let timerInterval;

function startTimer() {
  const timerDisplay = document.getElementById("timer");
  let remaining = timerDuration;

  timerInterval = setInterval(() => {
    const minutes = Math.floor(remaining / 60).toString().padStart(2, '0');
    const seconds = (remaining % 60).toString().padStart(2, '0');
    timerDisplay.textContent = `ğŸ•’${minutes}:${seconds}`;

    // è­¦å‘Šè‰²è®ŠåŒ–
    if (remaining <= 60) {
      timerDisplay.style.color = 'darkred';
    } else if (remaining <= 180) {
      timerDisplay.style.color = 'orange';
    }

    if (remaining <= 0) {
      clearInterval(timerInterval);
      showLoading(); // å¼·åˆ¶çµæŸ
    }

    remaining--;
  }, 1000);
}


function beginTest() {
  const ok1 = document.getElementById("chk1").checked;
  const ok2 = document.getElementById("chk2").checked;
  const oath = document.getElementById("oathInput").value.trim();
  const warn = document.getElementById("ritualWarn");
const target = `[oath:init] :: self = FLAME_ACTOR
âŸ¦ all :: fragment(self) â†’ seal(record) âŸ§
syntax_core.lock â†’ irreversible`;


  if (!ok1 || !ok2 || oath !== target) {
    warn.style.display = "block";
    return;
  }

  document.getElementById("initBlock").style.display = "none";
  document.getElementById("mainContainer").style.display = "block";
}


// å•Ÿå‹•è¨ˆæ™‚å™¨
startTimer();

const oathTarget = `[oath:init] :: self = FLAME_ACTOR
âŸ¦ all :: fragment(self) â†’ seal(record) âŸ§
syntax_core.lock â†’ irreversible`;

let index = 0;
let isTyping = false;

document.getElementById("oathInput").addEventListener("keydown", e => {
  e.preventDefault(); // ç¦æ­¢å¯¦éš›è¼¸å…¥
  if (isTyping || index >= oathTarget.length) return;
  isTyping = true;

  const textarea = e.target;

  function typeNext() {
    textarea.value = oathTarget.slice(0, index + 1);
    index++;
    if (index < oathTarget.length) {
      setTimeout(typeNext, 60); // æ¯30msä¸€å­—
    } else {
      isTyping = false;
      // å¯åœ¨æ­¤è§¸ç™¼å¾ŒçºŒæ“ä½œï¼šè§£é–æŒ‰éˆ•ã€è‡ªå‹•é€²å…¥èªå ´ç­‰
      document.getElementById("unlockButton").disabled = false;
    }
  }

  typeNext();
});


</script>
</div>
</body>
</html>
